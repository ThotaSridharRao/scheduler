<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Schedule Master</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script>
      // Tailwind CSS configuration (unchanged)
      tailwind.config = {
        theme: {
          extend: {
            colors: { primary: "#4F46E5", secondary: "#818CF8" },
            borderRadius: {
              none: "0px",
              sm: "4px",
              DEFAULT: "8px",
              md: "12px",
              lg: "16px",
              xl: "20px",
              "2xl": "24px",
              "3xl": "32px",
              full: "9999px",
              button: "8px",
            },
          },
        },
      };
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .font-pacifico {
        font-family: "Pacifico", cursive;
      }
      /* Custom scrollbar styles */
      .custom-scrollbar::-webkit-scrollbar {
        width: 8px; /* Width for vertical scrollbar */
        height: 8px; /* Height for horizontal scrollbar */
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1; /* Light grey track */
        border-radius: 10px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #888; /* Darker grey thumb */
        border-radius: 10px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #555; /* Even darker grey on hover */
      }
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 2rem;
        border-radius: 0.5rem;
        color: white;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transform: translateY(-100px);
        opacity: 0;
        transition: transform 0.5s ease-out, opacity 0.5s ease-out;
      }
      .notification.show {
        transform: translateY(0);
        opacity: 1;
      }
    </style>
  </head>
  <body class="bg-gradient-to-br from-primary to-secondary min-h-screen text-gray-800">
    <div id="notification-container"></div>

    <div class="container mx-auto p-4">
      <header
        class="bg-white rounded-lg shadow-lg p-6 mb-8 flex flex-col md:flex-row justify-between items-center"
      >
        <h1 class="text-4xl font-pacifico text-primary mb-4 md:mb-0">
          Schedule Master
        </h1>
        <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
          <button
            id="logout-button"
            class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-6 rounded-button transition duration-300 ease-in-out shadow-md"
          >
            Logout
          </button>
          <a
            href="login.html"
            id="login-link"
            class="hidden bg-primary hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-button transition duration-300 ease-in-out shadow-md text-center"
          >
            Login
          </a>
          <a
            href="signup.html"
            id="signup-link"
            class="hidden bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-6 rounded-button transition duration-300 ease-in-out shadow-md text-center"
          >
            Sign Up
          </a>
        </div>
      </header>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <section class="lg:col-span-1 bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-2xl font-bold text-gray-700 mb-6">Add New Task</h2>
          <form id="task-form" class="space-y-4">
            <div>
              <label for="task-name" class="block text-sm font-medium text-gray-700"
                >Task Name</label
              >
              <input
                type="text"
                id="task-name"
                name="task-name"
                required
                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary focus:border-primary"
              />
            </div>
            <div>
              <label
                for="task-description"
                class="block text-sm font-medium text-gray-700"
                >Description (Optional)</label
              >
              <textarea
                id="task-description"
                name="task-description"
                rows="3"
                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary focus:border-primary"
              ></textarea>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label
                  for="task-date"
                  class="block text-sm font-medium text-gray-700"
                  >Due Date</label
                >
                <input
                  type="date"
                  id="task-date"
                  name="task-date"
                  required
                  class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary focus:border-primary"
                />
              </div>
              <div>
                <label
                  for="task-time"
                  class="block text-sm font-medium text-gray-700"
                  >Due Time</label
                >
                <input
                  type="time"
                  id="task-time"
                  name="task-time"
                  required
                  class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary focus:border-primary"
                />
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >Priority</label
              >
              <div class="mt-2 flex space-x-4">
                <label class="inline-flex items-center">
                  <input
                    type="radio"
                    name="priority"
                    value="low"
                    class="form-radio text-primary focus:ring-primary"
                  />
                  <span class="ml-2">Low</span>
                </label>
                <label class="inline-flex items-center">
                  <input
                    type="radio"
                    name="priority"
                    value="medium"
                    checked
                    class="form-radio text-primary focus:ring-primary"
                  />
                  <span class="ml-2">Medium</span>
                </label>
                <label class="inline-flex items-center">
                  <input
                    type="radio"
                    name="priority"
                    value="high"
                    class="form-radio text-primary focus:ring-primary"
                  />
                  <span class="ml-2">High</span>
                </label>
              </div>
            </div>
            <div>
              <label
                for="task-category"
                class="block text-sm font-medium text-gray-700"
                >Category</label
              >
              <select
                id="task-category"
                name="task-category"
                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary focus:border-primary"
              >
                <option value="work">Work</option>
                <option value="personal">Personal</option>
                <option value="health">Health</option>
                <option value="finance">Finance</option>
                <option value="home">Home</option>
                <option value="social">Social</option>
                <option value="education">Education</option>
                <option value="general">General</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >Duration (minutes)</label
              >
              <div class="flex items-center space-x-4">
                <input
                  type="range"
                  id="task-duration-range"
                  name="task-duration-range"
                  min="5"
                  max="240"
                  step="5"
                  value="30"
                  class="flex-grow accent-primary"
                />
                <input
                  type="number"
                  id="task-duration-number"
                  name="task-duration-number"
                  min="5"
                  max="240"
                  step="5"
                  value="30"
                  class="w-20 border border-gray-300 rounded-md shadow-sm p-2 text-center focus:ring-primary focus:border-primary"
                />
              </div>
            </div>
            <button
              type="submit"
              class="w-full bg-primary hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-button transition duration-300 ease-in-out shadow-lg"
            >
              Add Task
            </button>
          </form>
        </section>

        <section class="lg:col-span-2 bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-2xl font-bold text-gray-700 mb-6">Your Tasks</h2>
          <div class="mb-4 flex flex-wrap gap-4 items-center">
            <div class="relative flex-grow min-w-[150px]">
              <select
                id="filter-category"
                class="block w-full border border-gray-300 rounded-md shadow-sm p-2 pr-10 focus:ring-primary focus:border-primary appearance-none"
              >
                <option value="all">All Categories</option>
                <option value="work">Work</option>
                <option value="personal">Personal</option>
                <option value="health">Health</option>
                <option value="finance">Finance</option>
                <option value="home">Home</option>
                <option value="social">Social</option>
                <option value="education">Education</option>
                <option value="general">General</option>
              </select>
              <div
                class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700"
              >
                <i class="ri-arrow-down-s-line"></i>
              </div>
            </div>
            <div class="relative flex-grow min-w-[150px]">
              <select
                id="filter-status"
                class="block w-full border border-gray-300 rounded-md shadow-sm p-2 pr-10 focus:ring-primary focus:border-primary appearance-none"
              >
                <option value="all">All Statuses</option>
                <option value="pending">Pending</option>
                <option value="completed">Completed</option>
              </select>
              <div
                class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700"
              >
                <i class="ri-arrow-down-s-line"></i>
              </div>
            </div>
            <div class="relative flex-grow min-w-[150px]">
              <select
                id="sort-by"
                class="block w-full border border-gray-300 rounded-md shadow-sm p-2 pr-10 focus:ring-primary focus:border-primary appearance-none"
              >
                <option value="dueDate">Sort by Due Date</option>
                <option value="priority">Sort by Priority</option>
                <option value="name">Sort by Name</option>
              </select>
              <div
                class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700"
              >
                <i class="ri-arrow-down-s-line"></i>
              </div>
            </div>
          </div>
          <div
            id="task-list"
            class="space-y-4 custom-scrollbar max-h-[600px] overflow-y-auto pr-2"
          >
            <p class="text-center text-gray-500" id="no-tasks-message">
              No tasks to display. Add a new task above!
            </p>
          </div>
        </section>
      </div>
    </div>

    <div
      id="edit-task-modal"
      class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden p-4"
    >
      <div
        class="bg-white rounded-lg shadow-xl p-8 w-full max-w-lg relative max-h-[90vh] overflow-y-auto custom-scrollbar"
      >
        <button
          class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl"
          id="close-edit-modal"
        >
          <i class="ri-close-line"></i>
        </button>
        <h2 class="text-2xl font-bold text-gray-700 mb-6">Edit Task</h2>
        <form id="edit-task-form" class="space-y-4">
          <input type="hidden" id="edit-task-id" />
          <div>
            <label for="edit-task-name" class="block text-sm font-medium text-gray-700"
              >Task Name</label
            >
            <input
              type="text"
              id="edit-task-name"
              name="task-name"
              required
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary focus:border-primary"
            />
          </div>
          <div>
            <label
              for="edit-task-description"
              class="block text-sm font-medium text-gray-700"
              >Description (Optional)</label
            >
            <textarea
              id="edit-task-description"
              name="task-description"
              rows="3"
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary focus:border-primary"
            ></textarea>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label
                for="edit-task-date"
                class="block text-sm font-medium text-gray-700"
                >Due Date</label
              >
              <input
                type="date"
                id="edit-task-date"
                name="task-date"
                required
                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary focus:border-primary"
              />
            </div>
            <div>
              <label
                for="edit-task-time"
                class="block text-sm font-medium text-gray-700"
                >Due Time</label
              >
              <input
                type="time"
                id="edit-task-time"
                name="task-time"
                required
                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary focus:border-primary"
              />
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Priority</label
            >
            <div class="mt-2 flex space-x-4">
              <label class="inline-flex items-center">
                <input
                  type="radio"
                  name="edit-priority"
                  value="low"
                  class="form-radio text-primary focus:ring-primary"
                />
                <span class="ml-2">Low</span>
              </label>
              <label class="inline-flex items-center">
                <input
                  type="radio"
                  name="edit-priority"
                  value="medium"
                  class="form-radio text-primary focus:ring-primary"
                />
                <span class="ml-2">Medium</span>
              </label>
              <label class="inline-flex items-center">
                <input
                  type="radio"
                  name="edit-priority"
                  value="high"
                  class="form-radio text-primary focus:ring-primary"
                />
                <span class="ml-2">High</span>
              </label>
            </div>
          </div>
          <div>
            <label
              for="edit-task-category"
              class="block text-sm font-medium text-gray-700"
              >Category</label
            >
            <select
              id="edit-task-category"
              name="task-category"
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary focus:border-primary"
            >
              <option value="work">Work</option>
              <option value="personal">Personal</option>
              <option value="health">Health</option>
              <option value="finance">Finance</option>
              <option value="home">Home</option>
              <option value="social">Social</option>
              <option value="education">Education</option>
              <option value="general">General</option>
            </select>
          </div>
          <div>
            <label for="edit-task-status" class="block text-sm font-medium text-gray-700"
              >Status</label
            >
            <select
              id="edit-task-status"
              name="task-status"
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary focus:border-primary"
            >
              <option value="pending">Pending</option>
              <option value="completed">Completed</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Duration (minutes)</label
            >
            <div class="flex items-center space-x-4">
              <input
                type="range"
                id="edit-task-duration-range"
                name="task-duration-range"
                min="5"
                max="240"
                step="5"
                value="30"
                class="flex-grow accent-primary"
              />
              <input
                type="number"
                id="edit-task-duration-number"
                name="task-duration-number"
                min="5"
                max="240"
                step="5"
                value="30"
                class="w-20 border border-gray-300 rounded-md shadow-sm p-2 text-center focus:ring-primary focus:border-primary"
              />
            </div>
          </div>
          <button
            type="submit"
            class="w-full bg-primary hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-button transition duration-300 ease-in-out shadow-lg"
          >
            Update Task
          </button>
        </form>
      </div>
    </div>

    <script>
      // Base URL for your backend API
      const API_BASE_URL = 'https://scheduler-pkxg.onrender.com/api';

      // DOM Elements
      const logoutButton = document.getElementById("logout-button");
      const loginLink = document.getElementById("login-link");
      const signupLink = document.getElementById("signup-link");
      const taskForm = document.getElementById("task-form");
      const taskList = document.getElementById("task-list");
      const noTasksMessage = document.getElementById("no-tasks-message");
      const editTaskModal = document.getElementById("edit-task-modal");
      const closeEditModalButton = document.getElementById("close-edit-modal");
      const editTaskForm = document.getElementById("edit-task-form");
      const taskDurationRange = document.getElementById("task-duration-range");
      const taskDurationNumber = document.getElementById("task-duration-number");
      const editTaskDurationRange = document.getElementById("edit-task-duration-range");
      const editTaskDurationNumber = document.getElementById("edit-task-duration-number");
      const filterCategory = document.getElementById('filter-category');
      const filterStatus = document.getElementById('filter-status');
      const sortSelect = document.getElementById('sort-by');
      let tasks = []; // Store tasks fetched from the backend

      // --- Utility Functions ---

      function showNotification(message, bgColor, iconClass) {
        const notificationContainer = document.getElementById("notification-container");
        const notification = document.createElement("div");
        notification.className = `notification ${bgColor} transition-all duration-500 ease-out`;
        notification.innerHTML = `
          <i class="${iconClass} text-xl"></i>
          <span>${message}</span>
        `;
        notificationContainer.appendChild(notification);

        // Animate in
        setTimeout(() => {
          notification.classList.add("show");
        }, 50); // Small delay to allow reflow

        // Animate out and remove
        setTimeout(() => {
          notification.classList.remove("show");
          setTimeout(() => {
            notification.remove();
          }, 500); // Wait for transition to finish
        }, 3000); // Display for 3 seconds
      }

      // --- Authentication Check ---

      function checkAuthentication() {
        const token = localStorage.getItem('token');
        if (!token) {
          // No token, show login/signup links and hide logout
          logoutButton.classList.add('hidden');
          loginLink.classList.remove('hidden');
          signupLink.classList.remove('hidden');
          // Redirect to login page as this is a protected dashboard
          window.location.href = 'login.html';
        } else {
          // User is authenticated, hide login/signup links and show logout
          logoutButton.classList.remove('hidden');
          loginLink.classList.add('hidden');
          signupLink.classList.add('hidden');
          // Fetch tasks for the authenticated user
          fetchTasks();
        }
      }

      // --- API Calls ---

      async function fetchTasks() {
        const token = localStorage.getItem('token');
        if (!token) return; // Should be handled by checkAuthentication

        try {
          const response = await fetch(`${API_BASE_URL}/tasks`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            }
          });

          if (response.ok) {
            tasks = await response.json();
            renderTasks();
          } else if (response.status === 401) {
            // Token expired or invalid
            showNotification("Session expired. Please log in again.", "bg-red-500", "ri-error-warning-line");
            localStorage.removeItem('token');
            setTimeout(() => {
              window.location.href = 'login.html';
            }, 1500);
          } else {
            const errorData = await response.json();
            showNotification(`Failed to fetch tasks: ${errorData.message}`, "bg-red-500", "ri-error-warning-line");
          }
        } catch (error) {
          console.error("Error fetching tasks:", error);
          showNotification("Network error. Could not connect to server.", "bg-red-500", "ri-error-warning-line");
        }
      }

      async function addTask(taskData) {
        const token = localStorage.getItem('token');
        if (!token) return;

        try {
          const response = await fetch(`${API_BASE_URL}/tasks`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(taskData)
          });

          if (response.ok) {
            const newTask = await response.json();
            tasks.push(newTask); // Add new task to local array
            renderTasks();
            showNotification("Task added successfully!", "bg-green-500", "ri-check-line");
            taskForm.reset(); // Reset form after successful submission
            // Reset duration to default values for new task form
            taskDurationRange.value = 30;
            taskDurationNumber.value = 30;
          } else {
            const errorData = await response.json();
            showNotification(`Failed to add task: ${errorData.message}`, "bg-red-500", "ri-error-warning-line");
          }
        } catch (error) {
          console.error("Error adding task:", error);
          showNotification("Network error. Could not add task.", "bg-red-500", "ri-error-warning-line");
        }
      }

      async function updateTask(id, taskData) {
        const token = localStorage.getItem('token');
        if (!token) return;

        try {
          const response = await fetch(`${API_BASE_URL}/tasks/${id}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(taskData)
          });

          if (response.ok) {
            const updatedTask = await response.json();
            // Find and update the task in the local array
            const index = tasks.findIndex(task => task._id === id);
            if (index !== -1) {
              tasks[index] = updatedTask;
            }
            renderTasks();
            showNotification("Task updated successfully!", "bg-green-500", "ri-check-line");
            editTaskModal.classList.add('hidden'); // Close modal
          } else {
            const errorData = await response.json();
            showNotification(`Failed to update task: ${errorData.message}`, "bg-red-500", "ri-error-warning-line");
          }
        } catch (error) {
          console.error("Error updating task:", error);
          showNotification("Network error. Could not update task.", "bg-red-500", "ri-error-warning-line");
        }
      }

      async function deleteTask(id) {
        const token = localStorage.getItem('token');
        if (!token) return;

        if (!confirm("Are you sure you want to delete this task?")) {
          return;
        }

        try {
          const response = await fetch(`${API_BASE_URL}/tasks/${id}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          if (response.ok) {
            // Remove the task from the local array
            tasks = tasks.filter(task => task._id !== id);
            renderTasks();
            showNotification("Task deleted successfully!", "bg-green-500", "ri-check-line");
          } else {
            const errorData = await response.json();
            showNotification(`Failed to delete task: ${errorData.message}`, "bg-red-500", "ri-error-warning-line");
          }
        } catch (error) {
          console.error("Error deleting task:", error);
          showNotification("Network error. Could not delete task.", "bg-red-500", "ri-error-warning-line");
        }
      }

      // --- Render Tasks ---

      function renderTasks() {
        taskList.innerHTML = '';
        noTasksMessage.classList.add('hidden'); // Hide default message initially

        if (tasks.length === 0) {
          noTasksMessage.classList.remove('hidden');
          return;
        }

        // Apply filters
        let filteredTasks = [...tasks];
        const selectedCategory = filterCategory.value;
        const selectedStatus = filterStatus.value;

        if (selectedCategory !== 'all') {
            filteredTasks = filteredTasks.filter(task => task.category === selectedCategory);
        }
        if (selectedStatus !== 'all') {
            filteredTasks = filteredTasks.filter(task => task.status === selectedStatus);
        }

        // Apply sorting
        const sortBy = sortSelect.value;
        filteredTasks.sort((a, b) => {
            if (sortBy === 'dueDate') {
                // Combine date and time for accurate sorting
                const dateTimeA = new Date(`${a.dueDate}T${a.dueTime}`);
                const dateTimeB = new Date(`${b.dueDate}T${b.dueTime}`);
                return dateTimeA - dateTimeB;
            } else if (sortBy === 'priority') {
                const priorityOrder = { 'high': 3, 'medium': 2, 'low': 1 };
                return priorityOrder[b.priority] - priorityOrder[a.priority]; // High to low
            } else if (sortBy === 'name') {
                return a.name.localeCompare(b.name);
            }
            return 0;
        });

        if (filteredTasks.length === 0) {
            noTasksMessage.textContent = "No tasks match your current filters.";
            noTasksMessage.classList.remove('hidden');
            return;
        }


        filteredTasks.forEach(task => {
          const taskItem = document.createElement("div");
          taskItem.className = `bg-gray-50 p-4 rounded-lg shadow-sm border-l-4
            ${task.priority === 'high' ? 'border-red-500' :
              task.priority === 'medium' ? 'border-yellow-500' :
              'border-green-500'}
            flex items-center justify-between transition-all duration-300 ease-in-out
            ${task.status === 'completed' ? 'opacity-70 line-through' : ''}`;

          // Format date and time for display
          const dueDateObj = new Date(task.dueDate);
          const formattedDate = dueDateObj.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          });
          const [hours, minutes] = task.dueTime.split(':');
          const formattedTime = new Date(0, 0, 0, hours, minutes).toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
          });


          taskItem.innerHTML = `
            <div class="flex-1">
              <h3 class="text-lg font-semibold text-gray-800">${task.name}</h3>
              <p class="text-sm text-gray-600">${task.description || 'No description'}</p>
              <div class="text-sm text-gray-500 mt-1 flex flex-wrap gap-x-3">
                <span><i class="ri-calendar-line"></i> ${formattedDate}</span>
                <span><i class="ri-time-line"></i> ${formattedTime}</span>
                <span><i class="ri-flag-line"></i> ${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)} Priority</span>
                <span><i class="ri-folder-open-line"></i> ${task.category.charAt(0).toUpperCase() + task.category.slice(1)}</span>
                <span><i class="ri-hourglass-line"></i> ${task.duration} min</span>
              </div>
            </div>
            <div class="flex space-x-2 ml-4">
              <button data-id="${task._id}" data-status="${task.status}"
                      class="toggle-status-btn p-2 rounded-full
                      ${task.status === 'completed' ? 'bg-green-100 text-green-700 hover:bg-green-200' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}
                      transition duration-200 ease-in-out"
                      title="${task.status === 'completed' ? 'Mark as Pending' : 'Mark as Complete'}">
                <i class="ri-check-line text-lg"></i>
              </button>
              <button data-id="${task._id}"
                      class="edit-task-btn p-2 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition duration-200 ease-in-out"
                      title="Edit Task">
                <i class="ri-edit-line text-lg"></i>
              </button>
              <button data-id="${task._id}"
                      class="delete-task-btn p-2 rounded-full bg-red-100 text-red-700 hover:bg-red-200 transition duration-200 ease-in-out"
                      title="Delete Task">
                <i class="ri-delete-bin-line text-lg"></i>
              </button>
            </div>
          `;
          taskList.appendChild(taskItem);
        });
      }

      // --- Event Listeners ---

      logoutButton.addEventListener('click', () => {
        localStorage.removeItem('token');
        showNotification("Logged out successfully!", "bg-green-500", "ri-check-line");
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 1000);
      });

      taskForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const name = document.getElementById("task-name").value;
        const description = document.getElementById("task-description").value;
        const dueDate = document.getElementById("task-date").value;
        const dueTime = document.getElementById("task-time").value;
        const priority = document.querySelector('input[name="priority"]:checked').value;
        const category = document.getElementById("task-category").value;
        const duration = parseInt(document.getElementById("task-duration-number").value, 10);

        const taskData = { name, description, dueDate, dueTime, priority, category, duration };
        await addTask(taskData);
      });

      taskList.addEventListener('click', async (e) => {
        // Toggle Status
        if (e.target.closest('.toggle-status-btn')) {
          const btn = e.target.closest('.toggle-status-btn');
          const taskId = btn.dataset.id;
          const currentStatus = btn.dataset.status;
          const newStatus = currentStatus === 'completed' ? 'pending' : 'completed';
          await updateTask(taskId, { status: newStatus });
        }

        // Edit Task
        if (e.target.closest('.edit-task-btn')) {
          const btn = e.target.closest('.edit-task-btn');
          const taskId = btn.dataset.id;
          const taskToEdit = tasks.find(task => task._id === taskId);

          if (taskToEdit) {
            document.getElementById("edit-task-id").value = taskToEdit._id;
            document.getElementById("edit-task-name").value = taskToEdit.name;
            document.getElementById("edit-task-description").value = taskToEdit.description;
            document.getElementById("edit-task-date").value = taskToEdit.dueDate.split('T')[0]; // Ensure YYYY-MM-DD
            document.getElementById("edit-task-time").value = taskToEdit.dueTime;
            document.querySelector(`input[name="edit-priority"][value="${taskToEdit.priority}"]`).checked = true;
            document.getElementById("edit-task-category").value = taskToEdit.category;
            document.getElementById("edit-task-status").value = taskToEdit.status;
            document.getElementById("edit-task-duration-range").value = taskToEdit.duration;
            document.getElementById("edit-task-duration-number").value = taskToEdit.duration;

            editTaskModal.classList.remove('hidden');
          }
        }

        // Delete Task
        if (e.target.closest('.delete-task-btn')) {
          const btn = e.target.closest('.delete-task-btn');
          const taskId = btn.dataset.id;
          await deleteTask(taskId);
        }
      });

      closeEditModalButton.addEventListener('click', () => {
        editTaskModal.classList.add('hidden');
      });

      editTaskForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const taskId = document.getElementById("edit-task-id").value;
        const name = document.getElementById("edit-task-name").value;
        const description = document.getElementById("edit-task-description").value;
        const dueDate = document.getElementById("edit-task-date").value;
        const dueTime = document.getElementById("edit-task-time").value;
        const priority = document.querySelector('input[name="edit-priority"]:checked').value;
        const category = document.getElementById("edit-task-category").value;
        const status = document.getElementById("edit-task-status").value;
        const duration = parseInt(document.getElementById("edit-task-duration-number").value, 10);

        const updatedData = { name, description, dueDate, dueTime, priority, category, status, duration };
        await updateTask(taskId, updatedData);
      });

      // Sync range and number inputs for duration
      taskDurationRange.addEventListener('input', () => {
        taskDurationNumber.value = taskDurationRange.value;
      });
      taskDurationNumber.addEventListener('input', () => {
        taskDurationRange.value = taskDurationNumber.value;
      });

      editTaskDurationRange.addEventListener('input', () => {
        editTaskDurationNumber.value = editTaskDurationRange.value;
      });
      editTaskDurationNumber.addEventListener('input', () => {
        editTaskDurationRange.value = editTaskDurationNumber.value;
      });

      // Filter and Sort Event Listeners
      filterCategory.addEventListener('change', renderTasks);
      filterStatus.addEventListener('change', renderTasks);
      sortSelect.addEventListener('change', renderTasks);


      // --- Initial Load ---
      document.addEventListener("DOMContentLoaded", () => {
        // Set default date to today for new task form
        document.getElementById("task-date").valueAsDate = new Date();
        document.getElementById("task-time").value = "17:00"; // Default time

        checkAuthentication(); // Check authentication state on page load
      });
    </script>
  </body>
</html>